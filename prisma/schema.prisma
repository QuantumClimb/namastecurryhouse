// Prisma schema for Namaste Curry House (Production - PostgreSQL/Neon)

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model MenuCategory {
  id        Int        @id @default(autoincrement())
  name      String
  items     MenuItem[]
}

model MenuItem {
  id                      Int      @id @default(autoincrement())
  name                    String
  namePt                  String?      // Portuguese translation of name
  description             String
  descriptionPt           String?      // Portuguese translation of description
  price                   Float
  dietary                 String   // comma-separated dietary tags
  hasSpiceCustomization   Boolean  @default(false) // Toggle for spice level customization
  categoryId              Int
  category                MenuCategory @relation(fields: [categoryId], references: [id])
  imageUrl                String?      // Legacy: External image URL
  imageData               String?      // Base64 encoded image data stored in Neon
  imageMimeType           String?      // MIME type (image/jpeg, image/png, etc.)
  imageSize               Int?         // Image size in bytes
}

model Customer {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  phone     String
  addresses Json     // Array of delivery addresses
  orders    Order[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Order {
  id                    Int           @id @default(autoincrement())
  orderNumber           String        @unique // e.g., "ORD-20251102-001"
  
  // Customer Information
  customerId            Int?
  customer              Customer?     @relation(fields: [customerId], references: [id])
  customerName          String
  customerEmail         String
  customerPhone         String
  
  // Delivery Information
  deliveryAddress       Json          // {street, apartment, city, postalCode, country}
  deliveryInstructions  String?
  
  // Order Details
  orderItems            Json          // Array of cart items with quantities, customizations
  subtotal              Float
  deliveryFee           Float         @default(0)
  total                 Float
  
  // Status
  status                OrderStatus   @default(PENDING)
  paymentStatus         PaymentStatus @default(PENDING)
  
  // Payment Information
  paymentMethod         PaymentMethod
  stripePaymentIntentId String?       @unique
  stripeChargeId        String?
  stripeSessionId       String?       @unique // Stripe Checkout Session ID
  
  // Timestamps
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  confirmedAt           DateTime?
  completedAt           DateTime?
  
  @@index([orderNumber])
  @@index([customerEmail])
  @@index([status])
  @@index([createdAt])
}

enum OrderStatus {
  PENDING       // Order created, payment pending
  CONFIRMED     // Payment received
  PREPARING     // Kitchen is preparing
  READY         // Ready for delivery/pickup
  IN_TRANSIT    // Out for delivery
  DELIVERED     // Successfully delivered
  CANCELLED     // Order cancelled
}

enum PaymentStatus {
  PENDING       // Awaiting payment
  PROCESSING    // Payment being processed
  SUCCEEDED     // Payment successful
  FAILED        // Payment failed
  REFUNDED      // Payment refunded
}

enum PaymentMethod {
  WHATSAPP      // Order via WhatsApp
  STRIPE_CARD   // Stripe credit/debit card
  STRIPE_IDEAL  // Future: iDEAL payment
  CASH          // Future: Cash on delivery
}

model StoreStatus {
  id             Int       @id @default(1) // Single row table
  isOpen         Boolean   @default(true)
  closedMessage  String?   // Custom message to display when closed
  reopenTime     DateTime? // Expected reopening time
  updatedAt      DateTime  @updatedAt
  updatedBy      String?   // Admin user who made the change
  
  @@map("store_status")
}
